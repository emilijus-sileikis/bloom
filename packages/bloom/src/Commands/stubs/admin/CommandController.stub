<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Str;

class CommandController extends Controller
{
    public function index()
    {
        $commands = $this->getCommandsAndDescriptions();

        return view('admin.commands', compact('commands'));
    }

    public function show($commandName)
    {
        $commandDescription = $this->getCommandsAndDescriptions($commandName);

        return view('admin.command-details', compact('commandName', 'commandDescription'));
    }

    public function examples()
    {
        return view('admin.examples');
    }

    public function execute($commandName, Request $request)
    {
        // Validation
        $request->validate([
            'crudName' => 'required|string|max:30',
        ]);

        $crudName = $request->input('crudName');

        if ($commandName === 'bloom:delete') {

            $fullCommand = "$commandName $crudName";

            return $this->commandCall($fullCommand, $crudName);
        }

        if ($commandName === 'bloom:create') {
            $relatedModel = $request->input('relatedModel');
            $modelAttributes = $request->input('modelAttributes');
            $relationshipType = $request->input('relationshipType');

            if (!empty($relatedModel) && !empty($relationshipType)) {
                config(['command_from_frontend' => true]);
                $fullCommand = "$commandName $crudName \"$modelAttributes\" --related-model=$relatedModel --relation-type=$relationshipType --skip-relationships";

            } else {
                $fullCommand = "$commandName $crudName \"$modelAttributes\" --skip-relationships";

            }
            return $this->commandCall($fullCommand, $crudName);
        }

         else return redirect()->back()->with('error', "Command execution failed. {$commandName} is not a valid command.");
    }

    private function getCommandsAndDescriptions($specificCommand = null)
    {
        $commandsWithDescriptions = [];
        $commands = collect(Artisan::all())->filter(function ($command, $key) {
            return Str::startsWith($key, 'bloom:');
        });

        foreach ($commands as $key => $command) {
            $parts = explode(':', $key, 2);
            $commandName = count($parts) > 1 ? $parts[1] : $key;

            try {
                if ($specificCommand === null || $specificCommand === $key) {
                    Artisan::call('help', ['command_name' => $key]);
                    $description = Artisan::output();

                    $commandsWithDescriptions[] = [
                        'name' => $commandName,
                        'key' => $key,
                        'description' => $description,
                    ];

                    if ($specificCommand === $key) {
                        return $description;
                    }
                }
            } catch (\Exception $e) {
                $description = 'Command description not available.';
            }
        }

        return $specificCommand ? 'Command not found.' : $commandsWithDescriptions;
    }

    public function commandCall(string $fullCommand, mixed $crudName)
    {
        Artisan::call($fullCommand);

        $output = Artisan::output();

        // Check if the command was executed successfully
        if (str_starts_with($output, 'ERROR 1:')) {
            return redirect()->back()->with('error', "Command execution failed. {$crudName} CRUD already exists.");
        } elseif (str_starts_with($output, 'CREATION SUCCESS:')) {
            return redirect()->back()->with('status', "Command executed successfully! {$crudName} CRUD created.");
        } elseif (str_starts_with($output, 'DELETION SUCCESS:')) {
            return redirect()->back()->with('status', "Command executed successfully! {$crudName} CRUD deleted.");
        } elseif (str_starts_with($output, 'ERROR 2:')) {
            return redirect()->back()->with('error', "Command execution failed. Nothing to delete.");
        } else {
            return redirect()->back()->with('status', "Command executed successfully! Output: {$output}");
        }
    }
}
